<!DOCTYPE html>
<html lang="en">
<head>
<title>Fantasy Rumors</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, Helvetica, sans-serif;
}
</style>
</head>
<body>

<h1>Fantasy Rumors</h1>
<p>Randomly generated rumors</p>

<p id="demo"></p>
<button id="generateBtn">Generate Sentence</button>

<script>

const tables = {
    urban_place_adjective: [
        { value: "charming", weight: 2 },
        { value: "unusual", weight: 1 },
        { value: "bustling", weight: 1 }
    ],
    urban_place: [
        { value: "market", weight: 1 },
        { value: "alley", weight: 1 },
        { value: "square", weight: 1 }
    ],
    compass_direction: [
        { value: "north", weight: 2 },
        { value: "south", weight: 2 },
        { value: "east", weight: 1 },
        { value: "west", weight: 1 }
    ],
    landmark: [
        { value: "the cathedral", weight: 1 },
        { value: "the river", weight: 1 },
        { value: "the castle", weight: 1 }
    ],
    urban_location: [
        { value: "${compass_direction} of ${landmark}", weight: 1 }
    ],
    urban_subjectplural: [
        { value: "the merchants", weight: 1 },
        { value: "the performers", weight: 1 },
        { value: "the thieves", weight: 1 }
    ],
    urban_verbplural: [
        { value: "shout", weight: 1 },
        { value: "dance", weight: 1 },
        { value: "haggle", weight: 1 }
    ],
    urban_subjectsingular: [
        { value: "street performer", weight: 1 },
        { value: "pickpocket", weight: 1 },
        { value: "onion-seller", weight: 1 }
    ],
    urban_verbsingular: [
        { value: "sings", weight: 1 },
        { value: "sneaks", weight: 1 },
        { value: "prays", weight: 1 }
    ],
    urban_subjectverb: [
        { value: "${urban_subjectplural} ${urban_verbplural}", weight: 1 },
        { value: "${a:urban_subjectsingular} ${urban_verbsingular}", weight: 1 }
    ],
    sentence: [
        { value: "There's ${a:urban_place_adjective} ${urban_place} ${urban_location}. It's said that here, ${urban_subjectverb}.", weight: 1 }
    ]
};

function getIndefiniteArticle(word) {
    if (!word) return "a";
    return /^[aeiou]/i.test(word) ? "an" : "a";
}

function weightedRandom(items) {
    if (!Array.isArray(items)) return items;

    const normalizedItems = items.map(item =>
        typeof item === "object" && item.value !== undefined
            ? item
            : { value: item, weight: 1 }
    );

    const totalWeight = normalizedItems.reduce((sum, item) => sum + item.weight, 0);
    let random = Math.random() * totalWeight;

    for (const item of normalizedItems) {
        if (random < item.weight) {
            return item.value;
        }
        random -= item.weight;
    }

    return normalizedItems[normalizedItems.length - 1].value; // fallback
}

function resolve(template) {
    if (Array.isArray(template)) {
        return resolve(weightedRandom(template));
    }

    if (typeof template === "string") {
        return template.replace(/\$\{(a:)?(\w+)\}/g, (_, articleFlag, key) => {
            const value = tables[key];
            if (!value) return `[undefined:${key}]`;
            const resolved = resolve(value);

            if (articleFlag) {
                const article = getIndefiniteArticle(resolved);
                return `${article} ${resolved}`;
            }

            return resolved;
        });
    }

    return template;
}

const output = resolve(tables["sentence"]);
console.log(output);
document.getElementById("demo").innerText = output;

function generateSentence() {
const output = resolve(tables["sentence"]);
console.log(output);
document.getElementById("demo").innerText = output;
console.log("call me maybe " + output);
}

 // Initial generation
    resolve();

    // Button click
    document.getElementById("generateBtn").addEventListener("click", generateSentence);


</script>

</body>
</html>